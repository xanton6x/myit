<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ניהול קריאות IT</title>
    <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 p-8">
<div class="max-w-6xl mx-auto">
    <header class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800">ניהול תקלות IT</h1>
        <a href="dashboard.html" class="text-blue-600 hover:underline">חזרה לדף משתמש</a>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-blue-500">
            <h2 class="text-gray-500 text-sm font-bold uppercase">קריאות פתוחות</h2>
            <p id="stat-open" class="text-3xl font-bold">0</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-green-500">
            <h2 class="text-gray-500 text-sm font-bold uppercase">קריאות שנסגרו</h2>
            <p id="stat-closed" class="text-3xl font-bold">0</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-yellow-500">
            <h2 class="text-gray-500 text-sm font-bold uppercase">זמן טיפול ממוצע (שעות)</h2>
            <p id="stat-sla" class="text-3xl font-bold">0</p>
        </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <canvas id="ticketsChart" height="100"></canvas>
    </div>

    <div class="bg-white shadow-md rounded-lg overflow-hidden">
        </div>
</div>

    <script type="module">
        import { getAllTickets, closeTicket } from "./js/db.js";
let myChart; // משתנה גלובלי לגרף

getAllTickets((tickets) => {
    const tableBody = document.getElementById('admin-tickets-table');
    tableBody.innerHTML = "";

    let openCount = 0;
    let closedCount = 0;
    let totalSlaMs = 0;

    tickets.forEach(ticket => {
        const created = ticket.createdAt?.toDate();
        const closed = ticket.closedAt?.toDate();

        if (ticket.status === 'open') openCount++;
        else {
            closedCount++;
            if (closed && created) totalSlaMs += (closed - created);
        }

        // ... הקוד של יצירת שורות הטבלה (Row) שכתבנו קודם ...
        // (שים לב להשאיר אותו כאן)
    });

    // עדכון כרטיסי הסטטיסטיקה
    document.getElementById('stat-open').innerText = openCount;
    document.getElementById('stat-closed').innerText = closedCount;
    
    const avgSlaHrs = closedCount > 0 ? (totalSlaMs / (1000 * 60 * 60) / closedCount).toFixed(1) : 0;
    document.getElementById('stat-sla').innerText = avgSlaHrs;

    // עדכון הגרף
    updateChart(openCount, closedCount);
});

function updateChart(open, closed) {
    const ctx = document.getElementById('ticketsChart').getContext('2d');
    if (myChart) myChart.destroy(); // משמיד גרף קודם כדי לצייר מחדש

    myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['קריאות פתוחות', 'קריאות שנסגרו'],
            datasets: [{
                label: 'מצב קריאות נוכחי',
                data: [open, closed],
                backgroundColor: ['#3b82f6', '#10b981']
            }]
        },
        options: {
            indexAxis: 'y', // גרף אופקי נראה מקצועי יותר בדשבורד
            scales: { x: { beginAtZero: true } }
        }
    });
}
        // פונקציית עזר לסגירה (חייבת להיות גלובלית כי היא בתוך HTML string)
        window.handleClose = async (id) => {
            if(confirm("לסגור את הקריאה?")) {
                await closeTicket(id);
                // כאן נשלב בהמשך את שליחת המייל
            }
        };
    </script>
</body>
</html>